<!DOCTYPE html>
<html>
<head>
    <title>PeerJS Test</title>
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
</head>
<body>
    <h1>PeerJS Connection Test</h1>

    <div style="background: #fff3cd; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
        <strong>‚ö†Ô∏è Important:</strong> WebRTC connections do NOT work between two tabs in the same browser!
        <br>You must use <strong>two different browsers</strong> (e.g., Chrome + Brave, or Chrome + Firefox).
        <br><br>
        <strong>Test procedure:</strong>
        <ol>
            <li>Open this page in Chrome ‚Üí Click "Create Host"</li>
            <li>Open this page in Brave/Firefox ‚Üí Click "Join Host"</li>
        </ol>
    </div>

    <div>
        <h2>Host</h2>
        <button id="createHost">Create Host (ID: testhost123)</button>
        <div id="hostStatus">Not started</div>
    </div>
    <div>
        <h2>Joiner</h2>
        <button id="joinHost">Join Host</button>
        <div id="joinerStatus">Not started</div>
    </div>
    <div>
        <h2>Messages</h2>
        <button id="sendFromHost">Send from Host</button>
        <button id="sendFromJoiner">Send from Joiner</button>
        <div id="messages" style="max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px;"></div>
    </div>

    <script>
        let hostPeer = null;
        let joinerPeer = null;
        let hostConn = null;
        let joinerConn = null;

        const PEER_OPTIONS = {
            host: 'localhost',
            port: 9000,
            path: '/',
            debug: 3
        };

        function log(msg) {
            console.log(msg);
            const div = document.getElementById('messages');
            div.innerHTML += '<p style="margin: 2px 0;">' + msg + '</p>';
            div.scrollTop = div.scrollHeight;
        }

        document.getElementById('createHost').onclick = () => {
            log('Creating host peer...');
            hostPeer = new Peer('testhost123', PEER_OPTIONS);

            hostPeer.on('open', (id) => {
                log('‚úÖ Host peer opened with ID: ' + id);
                document.getElementById('hostStatus').textContent = 'Ready - ID: ' + id;
            });

            hostPeer.on('connection', (conn) => {
                log('üì• Host received connection from: ' + conn.peer);
                hostConn = conn;

                // Monitor ICE state
                const checkPC = () => {
                    const pc = conn.peerConnection;
                    if (pc) {
                        log('Host ICE: ' + pc.iceConnectionState + ', signaling: ' + pc.signalingState);
                        pc.oniceconnectionstatechange = () => {
                            log('Host ICE ‚Üí ' + pc.iceConnectionState);
                            if (pc.iceConnectionState === 'connected' || pc.iceConnectionState === 'completed') {
                                log('üéâ Host: ICE connected! Waiting for data channel...');
                            }
                            if (pc.iceConnectionState === 'failed') {
                                log('‚ùå Host: ICE FAILED - this usually means same-browser testing');
                            }
                        };
                        pc.ondatachannel = (e) => {
                            log('üéâ Host ondatachannel fired! Channel: ' + e.channel.label);
                        };
                    } else {
                        setTimeout(checkPC, 50);
                    }
                };
                checkPC();

                conn.on('open', () => {
                    log('üéâ Host: Connection OPENED!');
                    document.getElementById('hostStatus').textContent = 'Connected!';
                    document.getElementById('hostStatus').style.color = 'green';
                });

                conn.on('data', (data) => {
                    log('üì® Host received: ' + JSON.stringify(data));
                });

                conn.on('error', (err) => {
                    log('‚ùå Host connection error: ' + err);
                });
            });

            hostPeer.on('error', (err) => {
                log('‚ùå Host peer error: ' + err.type + ' - ' + err.message);
            });
        };

        document.getElementById('joinHost').onclick = () => {
            log('Creating joiner peer...');
            joinerPeer = new Peer(PEER_OPTIONS);

            joinerPeer.on('open', (id) => {
                log('‚úÖ Joiner peer opened with ID: ' + id);
                log('Connecting to host...');

                joinerConn = joinerPeer.connect('testhost123');

                // Monitor ICE state
                setTimeout(() => {
                    const pc = joinerConn.peerConnection;
                    if (pc) {
                        log('Joiner ICE: ' + pc.iceConnectionState + ', signaling: ' + pc.signalingState);
                        pc.oniceconnectionstatechange = () => {
                            log('Joiner ICE ‚Üí ' + pc.iceConnectionState);
                            if (pc.iceConnectionState === 'connected' || pc.iceConnectionState === 'completed') {
                                log('üéâ Joiner: ICE connected!');
                            }
                            if (pc.iceConnectionState === 'failed') {
                                log('‚ùå Joiner: ICE FAILED - this usually means same-browser testing');
                            }
                        };
                    }
                }, 100);

                joinerConn.on('open', () => {
                    log('üéâ Joiner: Connection OPENED!');
                    document.getElementById('joinerStatus').textContent = 'Connected!';
                    document.getElementById('joinerStatus').style.color = 'green';
                });

                joinerConn.on('data', (data) => {
                    log('üì® Joiner received: ' + JSON.stringify(data));
                });

                joinerConn.on('error', (err) => {
                    log('‚ùå Joiner connection error: ' + err);
                });
            });

            joinerPeer.on('error', (err) => {
                log('‚ùå Joiner peer error: ' + err.type + ' - ' + err.message);
            });
        };

        document.getElementById('sendFromHost').onclick = () => {
            if (hostConn && hostConn.open) {
                hostConn.send({ from: 'host', msg: 'Hello from host!', time: Date.now() });
                log('üì§ Host sent message');
            } else {
                log('‚ùå Host connection not open');
            }
        };

        document.getElementById('sendFromJoiner').onclick = () => {
            if (joinerConn && joinerConn.open) {
                joinerConn.send({ from: 'joiner', msg: 'Hello from joiner!', time: Date.now() });
                log('üì§ Joiner sent message');
            } else {
                log('‚ùå Joiner connection not open');
            }
        };
    </script>
</body>
</html>
